--- ../gen/ddr4_0_ex/ddr4_0_ex.srcs/sources_1/ip/ddr4_0/rtl/ip_top/ddr4_0_ddr4_mem_intfc.sv	2025-04-30 15:46:11.000000000 -0400
+++ ./ddr4_0_ddr4_mem_intfc.sv	2025-04-30 11:08:12.000000000 -0400
@@ -64,6 +64,7 @@
 // Revision History :
 //*****************************************************************************
 
+`include "../../../../../../../../src/opendram/opendram_mc.sv"
 
 `timescale 1ps/1ps
 
@@ -260,6 +261,19 @@
    ,parameter         CAL_JITTER           = "FULL"
    ,parameter         t200us               = 53305
    ,parameter         t500us               = 133263
+
+   // added by Danesh
+   ,parameter         CMD_TYPE_WIDTH       = 3
+   ,parameter         NUM_CH               = 1
+   ,parameter         NUM_RNK              = 1
+   ,parameter         NUM_BG               = 2 ** BANK_GROUP_WIDTH
+   ,parameter         NUM_BNK              = 2 ** BANK_WIDTH
+   ,parameter         CH_WIDTH             = 1
+   ,parameter         RNK_WIDTH            = 1
+   ,parameter         QUEUE_SIZE           = 8
+   ,parameter         QUEUE_SIZE_WIDTH     = 5
+   ,parameter         GFIFO_SIZE           = 8
+   ,parameter         GFIFO_WIDTH          = 3
 )
   (
     input                           sys_clk_p
@@ -761,166 +775,139 @@
 localparam tWTR_L_HOST = (LRDIMM_MODE=="ON") ? tWTR_L + LRDIMM_DELAY : tWTR_L;
 localparam tRTW_HOST   = (LRDIMM_MODE=="ON") ? tRTW + LRDIMM_DELAY : tRTW;
 
-ddr4_v2_2_16_mc # (
-    .ABITS            (ADDR_WIDTH)
-   ,.COLBITS          (COL_WIDTH)
-   ,.BABITS           (BANK_WIDTH)
-   ,.BGBITS           (BANK_GROUP_WIDTH)
-   ,.CKEBITS          (CKE_WIDTH)
-   ,.S_HEIGHT         (S_HEIGHT)
-   ,.LR_WIDTH         (LR_WIDTH)
-   ,.ALIAS_PAGE       (ALIAS_PAGE)
-   ,.ALIAS_P_CNT      (ALIAS_P_CNT)
-   ,.CSBITS           (CS_WIDTH)
-   ,.ODTBITS          (ODT_WIDTH)
-   ,.MEM              (DRAM_TYPE)
-   ,.ECC              (ECC)
-   ,.PAYLOAD_WIDTH    (PAYLOAD_WIDTH)
-   ,.PAYLOAD_DM_WIDTH (PAYLOAD_DM_WIDTH)
-   ,.ECC_WIDTH        (ECC_WIDTH)
-   ,.ADDR_FIFO_WIDTH  (ADDR_FIFO_WIDTH_INT)
-   ,.DQ_WIDTH         (DQ_WIDTH)
-   ,.DM_WIDTH         (DM_WIDTH)
-   ,.DQS_WIDTH        (DQS_WIDTH)
-   ,.DBAW             (DATA_BUF_ADDR_WIDTH)
-   ,.NUMREF           (NUMREF)
-   ,.RANKS            (RANKS)
-   ,.RANK_SLOT        (RANK_SLOT)
-   ,.RKBITS           (RKBITS)
-   ,.RANK_SLAB        (RANK_SLAB)
-   ,.ORDERING         (ORDERING)
-   ,.TXN_FIFO_BYPASS  (TXN_FIFO_BYPASS)
-   ,.TXN_FIFO_PIPE    (TXN_FIFO_PIPE)
-   ,.PER_RD_PERF      (PER_RD_PERF)
-   ,.CAS_FIFO_BYPASS  (CAS_FIFO_BYPASS)
-   ,.NOP_ADD_LOW        (NOP_ADD_LOW)
-   ,.STARVATION_EN      (STARVATION_EN)
-   ,.STARVE_COUNT_WIDTH (STARVE_COUNT_WIDTH)   
-   ,.DDR4_CLAMSHELL     (DDR4_CLAMSHELL)
-   ,.MEM_CONFIG       (MEMORY_CONFIGURATION)
-   ,.REG_CTRL         (REG_CTRL)
-   ,.PARTIAL_RECONFIG (PARTIAL_RECONFIG)
-   ,.tFAW             (tFAW)
-   ,.tFAW_dlr         (tFAW_dlr)
-   ,.tRTW             (tRTW_HOST)
-   ,.tWTR_L           (tWTR_L_HOST)
-   ,.tWTR_S           (tWTR_S_HOST)
-   ,.tRFC             (tRFC)
-   ,.tRFC_dlr         (tRFC_dlr)
-   ,.tREFI            (tREFI)
-   ,.ZQINTVL          (ZQINTVL)
-   ,.tZQCS            (tZQCS)
-   ,.tRP              (tRP)
-   ,.tRRD_L           (tRRD_L)
-   ,.tRRD_S           (tRRD_S)
-   ,.tRRD_dlr         (tRRD_dlr)
-   ,.tRAS             (tRAS)
-   ,.tRCD             (tRCD)
-   ,.tRTP             (tRTP)
-   ,.tWR              (tWR)
-   ,.tCCD_3ds         (tCCD_3ds)
-   ,.MR6              (MR6)
-   ,.PER_RD_INTVL     (PER_RD_INTVL)
-   ,.ODTWR            (ODTWR)
-   ,.ODTWRDEL         (ODTWRDEL)
-   ,.ODTWRDUR         (ODTWRDUR)
-   ,.ODTWRODEL        (ODTWRODEL)
-   ,.ODTWRODUR        (ODTWRODUR)
-   ,.ODTRD            (ODTRD)
-   ,.ODTRDDEL         (ODTRDDEL)
-   ,.ODTRDDUR         (ODTRDDUR)
-   ,.ODTRDODEL        (ODTRDODEL)
-   ,.ODTRDODUR        (ODTRDODUR)
-   ,.ODTNOP           (ODTNOP)
-   ,.TCQ              (TCQ/1000)
-) u_ddr_mc (
-    .clk      (div_clk)
-   ,.rst      (div_clk_rst)
-   ,.calDone  (calDone)
-   ,.tCWL     (tCWL)
-
-   // Outputs to PHY
-   ,.mcCKt    (mcCKt)
-   ,.mcCKc    (mcCKc)
-   ,.mc_ACT_n (mc_ACT_n)
-   ,.mc_RAS_n (mc_RAS_n)
-   ,.mc_CAS_n (mc_CAS_n)
-   ,.mc_WE_n  (mc_WE_n)
-   ,.mc_ADR   (mc_ADR)
-   ,.mc_BA    (mc_BA)
-   ,.mc_BG    (mc_BG)
-   ,.mc_C     (mc_C)
-   ,.mc_CKE   (mc_CKE)
-   ,.mc_CS_n  (mc_CS_n)
-   ,.mc_ODT   (mc_ODT)
-   ,.wr_data_mc2phy      (wr_data_mc2phy)
-   ,.wr_data_mask_mc2phy (wr_data_mask_mc2phy)
-   ,.wr_data_addr_phy2mc (wrDataAddr)
-
-   // control outputs
-   ,.casSlot       (mcCasSlot)
-   ,.casSlot2      (mcCasSlot2)
-   ,.rdCAS         (mcRdCAS)
-   ,.wrCAS         (mcWrCAS)
-   ,.winInjTxn     (winInjTxn)
-   ,.winRmw        (winRmw)
-   ,.gt_data_ready (gt_data_ready)
-   ,.winBuf        (winBuf)
-   ,.win_rank_cas  (winRank)
-
-   // user interface
-   ,.rank     (rank)
-   ,.bank     (bank)
-   ,.group    (group[BANK_GROUP_WIDTH-1:0])
-   ,.lr       (lr)
-   ,.row      (row_mc_phy[ADDR_WIDTH-1:0])
-   ,.col      (col)
-   ,.cmd      (cmd)
-   ,.ap       (autoprecharge)
-   ,.hiPri    (hiPri)
-   ,.size     (size)
-   ,.accept   (accept)
-   ,.accept_ns(accept_ns)
-   ,.useAdr   (useAdr)
-   ,.dBufAdr  (dBufAdr)
-   ,.ref_req  (ref_req)
-   ,.zq_req   (zq_req)
-   ,.ref_ack  (ref_ack)
-   ,.zq_ack   (zq_ack)
-   ,.raw_not_ecc         (raw_not_ecc)
-   ,.correct_en          (correct_en)
-   ,.wr_data_ni2mc       (wr_data_ni2mc)
-   ,.wr_data_mask_ni2mc  (wr_data_mask_ni2mc)
-   ,.rd_data_mc2ni       (rd_data_mc2ni)
-   ,.rd_data_addr_mc2ni  (rd_data_addr_mc2ni)
-   ,.rd_data_en_mc2ni    (rd_data_en_mc2ni)
-   ,.rd_data_end_mc2ni   (rd_data_end_mc2ni)
-   ,.ecc_err_addr        (ecc_err_addr)
-   ,.eccSingle           (eccSingle)
-   ,.eccMultiple         (eccMultiple)
-   ,.rd_data_phy2mc      (rd_data_phy2mc)
-   ,.fi_xor_we           (fi_xor_we)
-   ,.fi_xor_wrdata       (fi_xor_wrdata)
-   ,.fi_xor_wrdata_en    (wrDataEn)
-
-   // Inputs from Phy
-   ,.per_rd_done         (per_rd_done)
-   ,.rmw_rd_done         (rmw_rd_done)
-   ,.rd_data_phy2mc_xif  (rd_data_phy2mc_xif)
-   ,.rd_data_addr_phy2mc (rd_data_addr_phy2mc)
-   ,.rd_data_en_phy2mc   (rd_data_en_phy2mc)
-   ,.rd_data_end_phy2mc  (rd_data_end_phy2mc)
-
-   ,.sre_req                 (app_sr_req)
-   ,.sre_ack                 (app_sr_active)
-   ,.ui_busy                 (ui_busy) 
-   ,.mc_block_req            (mc_block_req)
-   ,.stop_gate_tracking_req  (stop_gate_tracking_req)
-   ,.stop_gate_tracking_ack  (stop_gate_tracking_ack)
-   ,.cmd_complete            (cmd_complete)
-   ,.srx_cke0_release        (srx_cke0_release)
-   ,.srx_req                 (srx_req)
-   ,.dbg_out                 (dbg_out_mc)
+opendram_mc #(
+
+    .MEM                   ("DDR4")
+    ,.TCQ                  (100)
+
+    ,.NUM_CH               (NUM_CH)
+    ,.NUM_RNK              (NUM_RNK)
+    ,.RANKS                (RANKS)
+    ,.NUM_BG               (NUM_BG)
+    ,.NUM_BNK              (NUM_BNK)
+    
+    ,.CH_WIDTH             (CH_WIDTH)
+    ,.RNK_WIDTH            (RKBITS)
+    ,.BG_WIDTH             (BANK_GROUP_WIDTH)
+    ,.BNK_WIDTH            (BANK_WIDTH)
+    ,.ROW_WIDTH            (ADDR_WIDTH)
+    ,.COL_WIDTH            (COL_WIDTH)
+
+    ,.S_HEIGHT             (S_HEIGHT)
+    ,.LR_WIDTH             (LR_WIDTH)
+
+    ,.CKE_WIDTH            (CKE_WIDTH)
+    ,.CS_WIDTH             (CS_WIDTH)
+    ,.ABITS                (ADDR_WIDTH)
+    ,.BGBITS               (BANK_GROUP_WIDTH)
+    ,.BABITS               (BANK_WIDTH)
+
+    ,.DPTR_WIDTH           (DATA_BUF_ADDR_WIDTH)
+    ,.CMD_TYPE_WIDTH       (CMD_TYPE_WIDTH)
+
+    ,.ADDR_FIFO_WIDTH      (ADDR_FIFO_WIDTH)
+    ,.QUEUE_SIZE           (QUEUE_SIZE)
+    ,.QUEUE_SIZE_WIDTH     (QUEUE_SIZE_WIDTH)
+    ,.GFIFO_SIZE           (GFIFO_SIZE)
+
+    ,.ECC                  (ECC)
+    ,.ECC_WIDTH            (ECC_WIDTH)
+    ,.PAYLOAD_WIDTH        (PAYLOAD_WIDTH)
+    ,.PAYLOAD_DM_WIDTH     (PAYLOAD_DM_WIDTH)
+
+    ,.ODTWRDEL             (ODTWRDEL)
+    ,.ODTRD                (ODTRD)
+    ,.ODTWRDUR             (ODTWRDUR)
+    ,.ODTWRODEL            (ODTWRODEL)
+    ,.ODTWRODUR            (ODTWRODUR)
+    ,.ODTRDDUR             (ODTRDDUR)
+    ,.ODTRDODEL            (ODTRDODEL)
+    ,.ODTRDODUR            (ODTRDODUR)
+    ,.ODTNOP               (ODTNOP)
+
+    ,.ODTBITS              (ODT_WIDTH)
+    ,.PER_RD_INTVL         (PER_RD_INTVL)
+    ,.tREFI                (tREFI)
+    ,.tRFC                 (tRFC)
+    ,.tRP                  (tRP)
+    ,.tWR                  (tWR)
+    ,.ZQINTVL              (ZQINTVL)
+    ,.tCK                  (tCK)
+    ,.MR6                  (MR6)
+    ,.ODTWR                (ODTWR)
+    ,.ODTRDDEL             (ODTRDDEL)
+
+    ,.DQ_WIDTH             (DQ_WIDTH)
+    ,.DQS_WIDTH            (DQS_WIDTH)
+    ,.DM_WIDTH             (DM_WIDTH)
+    ,.nCK_PER_CLK          (nCK_PER_CLK)
+
+) opendram_mc_inst (
+
+    .clk                      (div_clk)
+    ,.rst_n                   (~div_clk_rst)
+
+    ,.mc_ACT_n                (mc_ACT_n)
+    ,.mc_RAS_n                (mc_RAS_n)
+    ,.mc_CAS_n                (mc_CAS_n)
+    ,.mc_WE_n                 (mc_WE_n)
+    ,.mc_ADR                  (mc_ADR)
+    ,.mc_BA                   (mc_BA)
+    ,.mc_BG                   (mc_BG)
+    ,.mc_C                    (mc_C)
+    ,.mc_CKE                  (mc_CKE)
+    ,.mc_CS_n                 (mc_CS_n)
+    ,.mc_ODT                  (mc_ODT)
+    ,.wr_data_mc2phy          (wr_data_mc2phy)
+    ,.wr_data_mask_mc2phy     (wr_data_mask_mc2phy)
+    ,.wr_data_addr_phy2mc     (wrDataAddr)
+    ,.wr_data_ni2mc           (wr_data_ni2mc)
+    ,.wr_data_mask_ni2mc      (wr_data_mask_ni2mc)
+    ,.rd_data_mc2ni           (rd_data_mc2ni)
+    ,.rd_data_addr_mc2ni      (rd_data_addr_mc2ni)
+    ,.rd_data_en_mc2ni        (rd_data_en_mc2ni)
+    ,.rd_data_end_mc2ni       (rd_data_end_mc2ni)
+    ,.rd_data_phy2mc          (rd_data_phy2mc)
+    ,.rd_data_phy2mc_xif      (rd_data_phy2mc_xif)
+    ,.rd_data_addr_phy2mc     (rd_data_addr_phy2mc)
+    ,.rd_data_en_phy2mc       (rd_data_en_phy2mc)
+    ,.rd_data_end_phy2mc      (rd_data_end_phy2mc)
+    ,.casSlot                 (mcCasSlot)    
+    ,.casSlot2                (mcCasSlot2)      
+    ,.rdCAS                   (mcRdCAS)  
+    ,.wrCAS                   (mcWrCAS)  
+    ,.win_data_ptr            (winBuf)    
+    ,.winInjTxn               (winInjTxn)   
+    ,.gt_data_ready           (gt_data_ready)          
+    ,.win_rank_cas            (winRank)
+    ,.rank                    (rank)
+    ,.group                   (group)
+    ,.bank                    (bank)
+    ,.row                     (row_mc_phy[ADDR_WIDTH-1:0])
+    ,.col                     (col)
+    ,.dBufAdr                 (dBufAdr)
+    ,.req_type                (cmd)
+    ,.ap                      (autoprecharge)
+    ,.useAdr                  (useAdr)
+    ,.mc_accept               (accept_ns)
+    ,.init_data_rd            (rd_data_en_mc2ni)
+    ,.init_data_wr            (wrDataEn)
+    ,.done_rd_dptr            (rd_data_addr_mc2ni)
+    ,.done_wr_dptr            (wrDataAddr)
+    ,.calDone                 (calDone)
+    ,.mcCKt                   (mcCKt)
+    ,.mcCKc                   (mcCKc)
+    ,.tCWL                    (tCWL)
+    ,.stop_gate_tracking_ack  (stop_gate_tracking_ack)
+    ,.stop_gate_tracking_req  (stop_gate_tracking_req)
+    ,.per_rd_done             (per_rd_done)
+    ,.ref_req                 () 
+    ,.zq_req                  () 
+    ,.sre_req                 () 
+    ,.sre_ack                 () 
+    ,.ui_busy                 () 
+    ,.mc_block_req            (mc_block_req)    
+    ,.cmd_complete            ()       
 );
 
   assign rdDataOffset = 1'b0;
@@ -1232,7 +1219,7 @@
    ,.mcRdCAS                     (mcRdCAS)
    ,.mcWrCAS                     (mcWrCAS)
    ,.winInjTxn                   (winInjTxn)
-   ,.winRmw                      (winRmw)
+   ,.winRmw                      (1'b0)
    ,.gt_data_ready               (gt_data_ready)
    ,.winBuf                      (winBuf)
    ,.winRank                     (winRank_phy)
